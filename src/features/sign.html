<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åŸºäºcanvaså®ç°ç”µå­ç­¾å</title>
    <!-- https://symbl.cc/cn/unicode-table/#arrows -->
    <style>
      /* é€šé…ç¬¦ */
      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }

      #canvas {
        width: 100%;
        height: 100%;
      }

      .top-tools {
        position: fixed;
        top: 3px;
        left: 50%;
        z-index: 1;
        padding: 4px;
        background-color: #d8d8d8;
        border-radius: 4px;
        box-shadow:
          0 0 0 1px rgb(0 0 0 / 5%),
          0 2px 4px 1px rgb(0 0 0 / 9%);
        transform: translateX(-50%);

        /* IE 10+ */
        -ms-user-select: none;

        /* Firefox */
        -moz-user-select: none;

        /* Safari */
        -webkit-user-select: none;

        /* ç¦æ­¢ç”¨æˆ·é€‰ä¸­æ–‡æœ¬ */
        user-select: none;

        /* èƒŒæ™¯æ¨¡ç³Š */
        backdrop-filter: blur(1px);
      }

      .top-tools span {
        /* é‡ç½®æ ·å¼ */
        all: unset;
        padding: 2px 5px;
        margin: 0 3px;
        font-size: 1.2em;
        border-radius: 4px;
        cursor: pointer;
      }

      .top-tools span:hover {
        color: #3498db;
        background-color: #c8c8c8;
      }

      .checked {
        color: #3498db;
        background-color: #c8c8c8;
      }

      input[type='color'] {
        all: unset;
        width: 2em;
        height: 1.2em;
        border-radius: 2px;
      }

      .refresh-icon {
        /* æ—‹è½¬åŠ¨ç”» */
        animation: spin 0.5s linear 1;
      }

      @keyframes spin {
        from {
          /* åˆå§‹è§’åº¦ */
          transform: rotate(0deg);
        }

        to {
          /* æ—‹è½¬360åº¦ */
          transform: rotate(360deg);
        }
      }

      /* éšè—å¤é€‰æ¡† */
      #eraser {
        display: none;
      }
    </style>
  </head>

  <body>
    <canvas id="canvas"></canvas>
    <div class="top-tools">
      <span title="é¢œè‰²é€‰æ‹©å™¨"><input type="color" onchange="changeColor(this.value)" /></span>
      <span title="æ’¤é”€" onclick="undo()">&#8630;</span>
      <span title="é‡åš" onclick="redo()">&#8631;</span>
      <span title="æ©¡çš®æª«">
        <input type="checkbox" id="eraser" onchange="changeEraser(this)" />
        <label for="eraser">ğŸ§½</label>
      </span>
      <span title="ç”»ç¬”ç²—ç»†">
        <input type="range" min="1" max="30" value="1" step="1" onchange="changeWidth(this.value)" />
      </span>
      <span title="ä¿å­˜" onclick="saveCanvas()">&#10003;</span>
      <span title="æ¸…ç©º" onclick="clearCanvas()">&#x21bb;</span>
    </div>

    <script>
      const cvs = document.getElementById('canvas');
      cvs.width = innerWidth * devicePixelRatio;
      cvs.height = innerHeight * devicePixelRatio;

      const ctx = cvs.getContext('2d', {
        willReadFrequently: true, // å¼€å¯é¢‘ç¹è¯»å–ç”»å¸ƒï¼Œæµè§ˆå™¨ä¼šåšä¸€äº›ä¼˜åŒ–
        imageSmoothingQuality: 'high' // è®¾ç½®æŠ—é”¯é½¿è´¨é‡
      });
      // æ’¤é”€é‡åš
      let undoList = [],
        redoList = [];
      ctx.lineWidth = ctx.lineWidth * devicePixelRatio;
      ctx.lineCap = 'round'; // è®¾ç½®çº¿æ¡æœ«ç«¯æ ·å¼
      ctx.lineJoin = 'round'; // è®¾ç½®çº¿æ¡è¿æ¥å¤„æ ·å¼

      cvs.addEventListener('mousedown', (e) => {
        this.isMouseDown = true; // é¼ æ ‡æŒ‰ä¸‹
        ctx.moveTo(e.pageX * devicePixelRatio, e.pageY * devicePixelRatio); // è®¾ç½®ç¬”è§¦èµ·å§‹ä½ç½®
        ctx.beginPath(); // å¼€å§‹ç»˜åˆ¶è·¯å¾„ï¼Œé˜²æ­¢ä¹‹å‰çš„ç‚¹åˆé‡æ–°ç”»å‡ºæ¥
      });

      cvs.addEventListener('mousemove', (e) => {
        if (this.isMouseDown) {
          ctx.lineTo(e.pageX * devicePixelRatio, e.pageY * devicePixelRatio); // ç»˜åˆ¶ç›´çº¿
          ctx.stroke(); // ç»˜åˆ¶è·¯å¾„
        }
      });

      cvs.addEventListener('mouseup', (e) => {
        this.isMouseDown = false;
        // ä¿å­˜ç”»å¸ƒæ•°æ®ï¼Œç”¨äºæ’¤é”€
        undoList.push(ctx.getImageData(0, 0, cvs.width, cvs.height));
      });

      /**
       * ä¿®æ”¹ç”»ç¬”é¢œè‰²
       */
      function changeColor(color) {
        ctx.strokeStyle = color;
      }

      /**
       * ä¿®æ”¹ç”»ç¬”ç²—ç»†
       * @param {number} value çº¿æ¡ç²—ç»†
       */
      function changeWidth(value) {
        ctx.lineWidth = value * devicePixelRatio;
      }

      /**
       * æ’¤é”€
       */
      function undo() {
        if (undoList.length > 0) {
          redoList.push(undoList.pop());
          reDraw();
        }
      }

      /**
       * é‡åš
       */
      function redo() {
        if (redoList.length > 0) {
          undoList.push(redoList.pop());
          reDraw();
        }
      }

      /**
       * æ”¹å˜æ©¡çš®æ“¦æ¨¡å¼
       * @param checkbox
       */
      function changeEraser(checkbox) {
        const label = document.querySelector(`label[for=${checkbox.id}]`);
        if (checkbox?.checked) {
          // æ©¡çš®æ“¦ï¼Œä»…ä¿ç•™ç”»ç¬”å¤–çš„å†…å®¹
          ctx.globalCompositeOperation = 'destination-out';
          label.classList.add('checked');
        } else {
          ctx.globalCompositeOperation = 'source-over';
          label.classList.remove('checked');
        }
      }

      /**
       * ä¿å­˜
       */
      function saveCanvas() {
        const a = document.createElement('a');
        a.href = cvs.toDataURL();
        a.download = `sign_${Date.now()}.png`;
        a.click();
        a.remove();
      }

      /**
       * æ¸…é™¤ç”»å¸ƒ
       */
      function clearCanvas() {
        if (!confirm('ç¡®å®šæ¸…ç©ºç”»å¸ƒï¼Ÿ')) return;
        ctx.clearRect(0, 0, cvs.width, cvs.height);
      }

      /**
       * é‡ç»˜
       */
      function reDraw() {
        if (undoList.length > 0) {
          ctx.putImageData(undoList[undoList.length - 1], 0, 0);
        } else {
          ctx.clearRect(0, 0, cvs.width, cvs.height);
        }
      }
    </script>
  </body>
</html>
